<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Flight Wizard - Step {{ step }}</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <style>
        .wizard-container { max-width: 800px; margin: 40px auto; background: rgba(0,0,0,0.85); padding: 30px; border-radius: 15px; border: 1px solid #444; }
        .wizard-header { border-bottom: 2px solid #ff9e22; padding-bottom: 15px; margin-bottom: 25px; display: flex; justify-content: space-between; align-items: center; }
        .step-indicator { color: #888; font-size: 0.9em; }
        .step-active { color: #ff9e22; font-weight: bold; }

        label { color: #ffb400; display: block; margin-bottom: 8px; font-weight: bold; }
        select, input { width: 100%; padding: 12px; margin-bottom: 15px; background: #222; border: 1px solid #555; color: white; border-radius: 4px; }
        select[multiple] { height: 200px; }

        .btn-next { background: #ff9e22; color: black; width: 100%; padding: 15px; font-weight: bold; border: none; cursor: pointer; font-size: 1.1em; transition: 0.2s; }
        .btn-next:hover { background: #e68a1f; }

        /* New Route Box */
        .new-route-box { background: rgba(23, 162, 184, 0.15); border: 1px solid #17a2b8; padding: 20px; border-radius: 8px; display: none; margin-top: 10px; }

        /* Disabled Inputs */
        input:disabled { background-color: #333; color: #777; cursor: not-allowed; border-color: #444; }
    </style>
</head>
<body>
    <header>
        <div class="header-container">
            <div style="color: var(--neon-yellow); font-family: 'Share Tech Mono', monospace; font-size: 0.9em; line-height: 1.2;">
                Please do not forget company policy,<br>put a smile on your face :)
            </div>

            <div></div>

            <div class="header-right-logo">
                <img src="{{ url_for('static', filename='logo.png') }}" width="120">
            </div>
        </div>
    </header>

    <main class="wizard-container">
        <div class="wizard-header">
            <h3 style="margin:0; color:white;">
                {% if step == 1 %}STEP 1: ROUTE & NETWORK
                {% elif step == 2 %}STEP 2: SCHEDULE & LOGISTICS
                {% elif step == 3 %}STEP 3: RESOURCES & PRICING{% endif %}
            </h3>
            <div class="step-indicator">
                <span class="{{ 'step-active' if step == 1 }}">1</span> &gt;
                <span class="{{ 'step-active' if step == 2 }}">2</span> &gt;
                <span class="{{ 'step-active' if step == 3 }}">3</span>
            </div>
        </div>

        {% with messages = get_flashed_messages(with_categories=true) %}
          {% if messages %}
            {% for category, message in messages %}
              <div class="flash-message {{ category }}" style="margin-bottom: 20px;">{{ message }}</div>
            {% endfor %}
          {% endif %}
        {% endwith %}

        {% if step == 1 %}
        <form action="/add_flight" method="POST">
            <input type="hidden" name="step" value="2">

            <label>Select Target Route</label>
            <select name="route_key" id="route_select" required onchange="toggleNewRoute(this)">
                <option value="" disabled selected>-- Select Route --</option>
                <option value="NEW" style="color: #17a2b8; font-weight: bold;">+ CREATE NEW ROUTE</option>
                <option disabled>----------------</option>
                {% for r in routes %}
                <option value="{{ r.source_airport }}-{{ r.destination_airport }}">
                    {{ r.source_airport }} ➝ {{ r.destination_airport }} ({{ r.flight_duration }} min)
                </option>
                {% endfor %}
            </select>

            <button type="submit" class="btn-next" id="btn-next">PROCEED TO SCHEDULING ➝</button>
        </form>

        <div id="new-route-form" class="new-route-box">
            <h4 style="color:#17a2b8; margin-top:0;">// ESTABLISH NEW ROUTE</h4>
            <form action="/add_route" method="POST">
                <input type="hidden" name="redirect_target" value="add_flight">
                <div style="display:flex; gap:10px;">
                    <input type="text" name="source_airport" placeholder="ORIGIN (TLV)" required maxlength="3" style="text-transform:uppercase;">
                    <input type="text" name="destination_airport" placeholder="DEST (JFK)" required maxlength="3" style="text-transform:uppercase;">
                </div>
                <input type="number" name="duration" placeholder="Duration (Minutes)" required>
                <button type="submit" class="btn-next" style="background:#17a2b8; color:white;">SAVE ROUTE</button>
            </form>
        </div>
        {% endif %}

        {% if step == 2 %}
        <form action="/add_flight" method="POST">
            <input type="hidden" name="step" value="3">
            <input type="hidden" name="source" value="{{ source }}">
            <input type="hidden" name="dest" value="{{ dest }}">
            <input type="hidden" name="duration" value="{{ duration }}">

            <div style="background: #333; padding: 15px; border-radius: 8px; margin-bottom: 20px;">
                <span style="color:#aaa;">SELECTED ROUTE:</span>
                <strong style="color:white; font-size:1.2em; margin-left: 10px;">{{ source }} ➝ {{ dest }}</strong>
                <span style="float:right; color:#ff9e22;">{{ duration }} min</span>
            </div>

            <label>Flight ID</label>
            <input type="text" name="flight_id" placeholder="FL-XXX" value="{{ prev_fid|default('') }}" required>

            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <label>Date</label>
                    <input type="date" name="departure_date" value="{{ prev_date|default('') }}" required>
                </div>
                <div style="flex:1;">
                    <label>Time</label>
                    <input type="time" name="departure_time" value="{{ prev_time|default('') }}" required>
                </div>
            </div>

            <label>Runway Assignment</label>
            <input type="text" name="runway_num" placeholder="e.g. R4" value="{{ prev_runway|default('') }}" required>
            <p style="font-size:0.8em; color:#ccc;">* Availability checked on next step.</p>

            <button type="submit" class="btn-next">VERIFY & FIND RESOURCES ➝</button>
        </form>
        {% endif %}

        {% if step == 3 %}
        <form action="/add_flight" method="POST">
            <input type="hidden" name="step" value="finish">
            <input type="hidden" name="flight_id" value="{{ flight_id }}">
            <input type="hidden" name="departure_date" value="{{ departure_date }}">
            <input type="hidden" name="departure_time" value="{{ departure_time }}">
            <input type="hidden" name="runway_num" value="{{ runway_num }}">
            <input type="hidden" name="source" value="{{ source }}">
            <input type="hidden" name="dest" value="{{ dest }}">
            <input type="hidden" name="duration" value="{{ duration }}">

            <div style="background: #28a745; padding: 10px; text-align: center; border-radius: 5px; margin-bottom: 20px; color: white; font-weight: bold;">
                ✓ ID & RUNWAY CONFIRMED AVAILABLE
            </div>

            <label>Select Aircraft (Available Only)</label>
            <select name="airplane_id" required onchange="updateFormState(this)">
                {% for p in planes %}
                <option value="{{ p.airplane_id }}" data-size="{{ p.size }}">
                    {{ p.airplane_id }} ({{ p.manufacturer }} - {{ p.size }})
                </option>
                {% endfor %}
            </select>

            <label>Select Crew (Available & Qualified)</label>
            <p class="hint" style="color: #ffb400; font-size: 0.8em;">Hold <b>CTRL</b> to select multiple.</p>
            <div style="display:flex; gap:20px; margin-bottom: 20px;">
                <div style="flex:1;">
                    <span id="pilot-label" style="color:#aaa; font-size:0.8em;">PILOTS (Select --)</span>
                    <select name="pilots" multiple required data-limit="0" onchange="limitSelection(this)">
                        {% for p in pilots %}
                        <option value="{{ p.pilot_id }}">{{ p.first_name }} {{ p.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div style="flex:1;">
                    <span id="attendant-label" style="color:#aaa; font-size:0.8em;">ATTENDANTS (Select --)</span>
                    <select name="attendants" multiple required data-limit="0" onchange="limitSelection(this)">
                        {% for a in attendants %}
                        <option value="{{ a.attendant_id }}">{{ a.first_name }} {{ a.last_name }}</option>
                        {% endfor %}
                    </select>
                </div>
            </div>

            <div style="display:flex; gap:20px;">
                <div style="flex:1;">
                    <label>Economy Price ($)</label>
                    <input type="number" step="0.01" name="price_economy" required>
                </div>
                <div style="flex:1;">
                    <label>Business Price ($)</label>
                    <input type="number" step="0.01" name="price_business" id="biz_price">
                </div>
            </div>

            <button type="submit" class="btn-next" style="background: #28a745; color: white;">AUTHORIZE FLIGHT</button>
        </form>
        {% endif %}

        <a href="/" style="display:block; text-align:center; margin-top:15px; color:#aaa; text-decoration: none;">Cancel / Restart</a>
    </main>

    <script>
        function toggleNewRoute(select) {
            const form = document.getElementById('new-route-form');
            const btn = document.getElementById('btn-next');
            if(select.value === 'NEW') {
                form.style.display = 'block';
                btn.style.display = 'none';
            } else {
                form.style.display = 'none';
                btn.style.display = 'block';
            }
        }

        function limitSelection(selectObj) {
            const limit = parseInt(selectObj.getAttribute('data-limit'));
            let count = 0;
            for(let opt of selectObj.options) if(opt.selected) count++;
            for(let opt of selectObj.options) if(!opt.selected) opt.disabled = count >= limit;
        }

        function updateFormState(select) {
            const size = select.options[select.selectedIndex].getAttribute('data-size');
            const biz = document.getElementById('biz_price');

            // 1. Handle Price Inputs
            if(size === 'Small') {
                biz.disabled = true;
                biz.placeholder = 'N/A (Small Plane)';
                biz.value = '';
                biz.style.backgroundColor = '#333';
            } else {
                biz.disabled = false;
                biz.placeholder = '';
                biz.style.backgroundColor = '#222';
            }

            // 2. Handle Crew Logic
            let reqPilots = 2;
            let reqAttendants = 3;

            if(size === 'Big') {
                reqPilots = 3;
                reqAttendants = 6;
            }

            // Update Labels to show user how many to select
            document.getElementById('pilot-label').innerText = `PILOTS (Select ${reqPilots})`;
            document.getElementById('attendant-label').innerText = `ATTENDANTS (Select ${reqAttendants})`;

            // Update Limits on the dropdowns
            const pilotSelect = document.querySelector('select[name="pilots"]');
            const attendantSelect = document.querySelector('select[name="attendants"]');

            pilotSelect.setAttribute('data-limit', reqPilots);
            attendantSelect.setAttribute('data-limit', reqAttendants);

            // Re-validate current selection (unselect extras if user downsized plane)
            limitSelection(pilotSelect);
            limitSelection(attendantSelect);
        }

        // Initialize on load
        document.addEventListener('DOMContentLoaded', function() {
            const planeSelect = document.querySelector('select[name="airplane_id"]');
            if(planeSelect) updateFormState(planeSelect);
        });
    </script>
</body>
</html>