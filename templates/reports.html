<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Manager Reports - FLYTAU</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        .reports-container { max-width: 1200px; margin: 20px auto; padding: 20px; }
        .grid { display: grid; grid-template-columns: 1fr 1fr; gap: 30px; margin-bottom: 40px; }
        .card { background: white; padding: 20px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.1); }
        .full-width { grid-column: span 2; }
        h2 { border-bottom: 2px solid #0056b3; padding-bottom: 10px; color: #333; }
        .stat-box { font-size: 3em; font-weight: bold; color: #28a745; text-align: center; margin: 40px 0; }

        table { width: 100%; border-collapse: collapse; margin-top: 10px; }
        th, td { padding: 10px; border: 1px solid #ddd; text-align: center; }
        th { background: #f4f4f4; }
    </style>
</head>
<body>
    <header>
        <div class="header-container" style="display:flex; justify-content:space-between; align-items:center; padding: 10px 40px; background:#fff; border-bottom:1px solid #ddd;">
            <img src="{{ url_for('static', filename='logo.png') }}" width="100">
            <h1>Managerial Reports</h1>
            <a href="/"><button style="background:#6c757d; color:white; border:none; padding:8px 15px; border-radius:4px; cursor:pointer;">Back to Dashboard</button></a>
        </div>
    </header>

    <main class="reports-container">

        <div class="grid">
            <div class="card">
                <h2>1. Average Flight Occupancy</h2>
                <div class="stat-box">{{ data.occupancy[0]['avg_capacity_percentage'] | round(2) }}%</div>
                <p style="text-align:center; color:#666;">Calculated based on executed flights only.</p>
            </div>

            <div class="card">
                <h2>4. Monthly Cancellation Rate</h2>
                <canvas id="cancelChart"></canvas>
            </div>

            <div class="card full-width">
                <h2>2. Total Revenue by Plane & Class</h2>
                <canvas id="revenueChart" height="100"></canvas>
            </div>

            <div class="card full-width">
                <h2>3. Crew Flight Hours (Short vs Long)</h2>
                <canvas id="crewChart" height="100"></canvas>
            </div>

            <div class="card full-width">
                <h2>5. Monthly Plane Activity Summary</h2>
                <div style="overflow-x: auto;">
                    <table>
                        <thead>
                            <tr>
                                <th>Plane ID</th>
                                <th>Month</th>
                                <th>Executed</th>
                                <th>Cancelled</th>
                                <th>Utilization %</th>
                                <th>Dominant Route</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for row in data.plane_activity %}
                            <tr>
                                <td>{{ row.airplane_id }}</td>
                                <td>{{ row.activity_month }}</td>
                                <td>{{ row.flights_executed }}</td>
                                <td style="color: {{ 'red' if row.flights_cancelled > 0 else 'black' }}">{{ row.flights_cancelled }}</td>
                                <td>{{ row.utilization_percentage }}%</td>
                                <td>{{ row.dominant_route or '-' }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

    </main>

    <script>
        const revenueData = {{ data.revenue | tojson }};
        const crewData = {{ data.crew | tojson }};
        const cancelData = {{ data.cancellations | tojson }};

        // Revenue Chart
        new Chart(document.getElementById('revenueChart'), {
            type: 'bar',
            data: {
                labels: revenueData.map(d => d.label),
                datasets: [{
                    label: 'Revenue ($)',
                    data: revenueData.map(d => d.total_revenue),
                    backgroundColor: '#0056b3',
                    borderRadius: 5
                }]
            }
        });

        // Crew Chart
        new Chart(document.getElementById('crewChart'), {
            type: 'bar',
            data: {
                labels: crewData.map(d => d.First_Name + ' ' + d.Last_Name + ' (' + d.Role + ')'),
                datasets: [
                    {
                        label: 'Short Flights (<6h)',
                        data: crewData.map(d => d.Short_Flight_Hours),
                        backgroundColor: '#28a745'
                    },
                    {
                        label: 'Long Flights (>6h)',
                        data: crewData.map(d => d.Long_Flight_Hours),
                        backgroundColor: '#ffc107'
                    }
                ]
            },
            options: { scales: { x: { stacked: true }, y: { stacked: true } } }
        });

        // Cancellations Chart
        new Chart(document.getElementById('cancelChart'), {
            type: 'line',
            data: {
                labels: cancelData.map(d => d.order_month),
                datasets: [{
                    label: 'Cancellation Rate (%)',
                    data: cancelData.map(d => d.cancellation_rate_percent),
                    borderColor: '#dc3545',
                    backgroundColor: 'rgba(220, 53, 69, 0.1)',
                    fill: true,
                    tension: 0.3
                }]
            },
            options: { scales: { y: { beginAtZero: true, max: 100 } } }
        });
    </script>
</body>
</html>