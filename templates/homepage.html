<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>FLYTAU - Departures</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='style.css') }}">
</head>
<body>

<header>
    <div class="header-container">
        <nav class="header-left-nav">
            <a href="/" class="nav-link-orange">DEPARTURES</a>
            {% if current_user.is_authenticated %}
                {% if current_user.user_type == 'Registered' %}
                    <a href="/mytrips" class="nav-link-orange">MY TRIPS</a>
                {% endif %}
                <a href="/logout" class="nav-link-orange">LOGOUT</a>
            {% endif %}
        </nav>

        <div class="header-center">
            {% if current_user.is_authenticated %}
                <span class="welcome-text-large">WELCOME BACK, <span class="user-name">{{ current_user.first_name }}</span></span>
            {% else %}
                <span class="welcome-text-large" style="color: #444;">/// GUEST ACCESS ///</span>
            {% endif %}
        </div>

        <div class="header-right-logo">
             <img src="{{ url_for('static', filename='logo.png') }}" alt="FLYTAU Logo" class="logo dimmed-logo" width="140">
        </div>
    </div>
</header>

<main class="main-content">

    {% with messages = get_flashed_messages(with_categories=true) %}
      {% if messages %}
        <div class="flash-container">
          {% for category, message in messages %}
            <div class="flash-message {{ category }}">
                <span class="icon">‚Ñπ</span> {{ message }}
            </div>
          {% endfor %}
        </div>
      {% endif %}
    {% endwith %}

    {% if not current_user.is_authenticated %}
    <section class="login-overlay">
        <div class="login-card">
            <h2 class="login-title">Member Login</h2>
            <p class="login-subtitle">Please enter your credentials</p>

            <form action="/login" method="POST" class="login-form">
                <div class="input-group">
                    <label>ID / Email</label>
                    <input type="text" name="id_or_email" placeholder="Email or ID" required>
                </div>
                <div class="input-group">
                    <label>Password</label>
                    <input type="password" name="password" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢‚Ä¢" required>
                </div>
                <button type="submit" class="login-btn">Login</button>
            </form>

            <div class="login-footer">
                <p>Don't have an account? <a href="/signup">Register Here</a></p>
            </div>
        </div>
    </section>
    {% endif %}

    {% if current_user.is_authenticated and current_user.user_type == 'Manager' %}
    <section class="manager-panel">
        <div class="manager-header">
            <h2>COMMAND CENTER</h2>
            <div class="manager-actions">
                <a href="{{ url_for('manager_reports') }}" class="btn-report">üìä SYSTEM REPORTS</a>
                <button onclick="document.getElementById('add-flight-div').toggleDisplay()" class="btn-create">
                    + NEW FLIGHT PLAN
                </button>
            </div>
        </div>

        <div id="add-flight-div" class="add-flight-form" style="display: none;">
            <h4>// UPLOAD NEW FLIGHT DATA</h4>
            <form action="/add_flight" method="POST" class="grid-form">
                <input type="text" name="flight_id" placeholder="FLIGHT ID (FL-XXX)" required>
                <input type="date" name="departure_date" id="flightDateInput" required>
                <input type="time" name="departure_time" required>
                <input type="text" name="source_airport" placeholder="ORIGIN (TLV)" required>
                <input type="text" name="destination_airport" placeholder="DESTINATION (JFK)" required>
                <input type="text" name="airplane_id" placeholder="AIRCRAFT ID" required>
                <input type="text" name="runway_num" placeholder="RUNWAY" required>
                <button type="submit" class="btn-save">EXECUTE UPLOAD</button>
            </form>
        </div>
    </section>
    {% endif %}

    <section class="search-section">
        <form method="GET" action="/" class="flight-search-bar">
            <div class="search-input">
                <span class="label">FROM</span>
                <input type="text" name="source" placeholder="TLV" value="{{ request.args.get('source', '') }}">
            </div>
            <div class="search-input">
                <span class="label">TO</span>
                <input type="text" name="dest" placeholder="ANYWHERE" value="{{ request.args.get('dest', '') }}">
            </div>
            <div class="search-input">
                <span class="label">DATE</span>
                <input type="date" name="date" value="{{ request.args.get('date', '') }}">
            </div>
            <button type="submit" class="search-btn">SCAN FLIGHTS</button>
        </form>
    </section>

    <section class="fids-display">
        <div class="fids-header">
            <span>FLIGHT</span>
            <span>DESTINATION</span>
            <span>TIME</span>
            <span>GATE/RWY</span>
            <span>STATUS</span>
            <span>ACTION</span>
        </div>

        <div class="fids-board">
            {% for flight in flights %}
            <div class="fids-row {{ 'row-cancelled' if flight.status == 'Cancelled' else '' }}">
                <div class="col-flight">{{ flight.flight_id }}</div>
                <div class="col-dest">
                    <span class="code">{{ flight.destination_airport }}</span>
                    <span class="route-line">‚Üê {{ flight.source_airport }}</span>
                </div>
                <div class="col-time">{{ flight.departure_time }} <span class="date-small">{{ flight.departure_date }}</span></div>
                <div class="col-gate">{{ flight.runway_num }}</div>

                <div class="col-status">
                    {% if flight.status == 'Active' %}
                        <span class="status-blink text-green">ON TIME</span>
                    {% elif flight.status == 'Cancelled' %}
                        <span class="text-red">CANCELLED</span>
                    {% elif flight.status == 'Arrived' %}
                         <span class="text-gray">LANDED</span>
                    {% else %}
                        <span class="text-yellow">{{ flight.status|upper }}</span>
                    {% endif %}
                </div>

                <div class="col-action">
                    {% if current_user.is_authenticated and current_user.user_type == 'Manager' %}
                        {% if flight.status in ['Active', 'Full Capacity'] %}
                        <form action="{{ url_for('cancel_flight', flight_id=flight.flight_id) }}" method="POST" onsubmit="return confirm('Cancel this flight and refund all passengers?');">
                            <button type="submit" class="action-btn btn-danger">ABORT</button>
                        </form>
                        {% else %}
                            <span class="locked-icon">üîí</span>
                        {% endif %}
                    {% else %}
                        {% if flight.status == 'Active' %}
                            <a href="{{ url_for('book_flight', flight_id=flight.flight_id) }}" class="action-btn btn-book">BOOK</a>
                        {% else %}
                            <span class="no-book">-</span>
                        {% endif %}
                    {% endif %}
                </div>
            </div>
            {% else %}
            <div class="fids-empty">
                NO FLIGHTS SCHEDULED FOR CURRENT PARAMETERS.
            </div>
            {% endfor %}
        </div>
    </section>

</main>

<footer>
    <p class="scrolling-text">/// WELCOME TO FLYTAU /// PLEASE KEEP YOUR LUGGAGE UNATTENDED AT YOUR OWN RISK /// ENJOY YOUR FLIGHT ///</p>
</footer>

<script>
    HTMLElement.prototype.toggleDisplay = function() {
        this.style.display = (this.style.display === 'none' || this.style.display === '') ? 'grid' : 'none';
    };
</script>

</body>
</html>